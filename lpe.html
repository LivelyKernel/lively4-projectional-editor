<!-- Link to precompiled libraries -->
<script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-projectional-editor/lib/blockly_compressed.js"></script>
<script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-projectional-editor/lib/babel.js"></script>

<!-- Here we start our own script -->
<script type="text/javascript">
// Since all scripts are loaded dynamically, they are loaded in parallel
// We try to assure that all dependencies are loaded by waiting 1 sec
// This shold be a temporary solution!
setTimeout(function() {
  // Load our own js code using System.js to make sure that it is transpiled
  System.import("../lively4-projectional-editor/lpe.js").then(function(lpe) {
    const test_types = [
      'Program',
      'VariableDeclaration',
      'VariableDeclarator',
      'Identifier',
      'NumericLiteral',
      'StringLiteral',
      'Literal',
      'BinaryExpression'
    ];
    var toolbox = '<xml>';
    
    for(var i = 0; i < test_types.length; i++) {
        const type = test_types[i];
        const type_name = 'babel_' + type;
        Blockly.Blocks[type_name] = lpe.blockDefinitionForNodeType(type);
        toolbox += '  <block type="' + type_name + '"></block>';
    }
    
    toolbox += '</xml>';
    
    const workspace = Blockly.inject(document.querySelector('#blocklyDiv'), {
        toolbox: toolbox,
        collapse: true,
        scrollbars: true
    });
    
    function onChange(event) {  
    
      if (event.type == Blockly.Events.MOVE) {  
      
         let block = workspace.getBlockById(event.blockId);
         
         if (block) {
            updateBlockConnections(block);            
         }       
      }
    }
    workspace.addChangeListener(onChange);
    
    function updateBlockConnections(block) {
        let prevConnected = block.previousConnection &&
            block.previousConnection.isConnected();
         let nextConnected = block.nextConnection &&
            block.nextConnection.isConnected();
         let outConnected = block.outputConnection &&
            block.outputConnection.isConnected();
                 
         if (prevConnected || nextConnected) {  
            block.setOutput(false, null);
         } else if (outConnected) {
            block.setPreviousStatement(false, null);
                block.setNextStatement(false, null);                
         } else {          
            block.setOutput(true, null);
            block.setPreviousStatement(true, null);
                block.setNextStatement(true, null);
         }
    }
    
    $("#button").on("click", () => {
        workspace.clear();
        try {
            lpe.createBlocksForCode($('#input').val(), workspace);
        } catch (e) {
            console.log(e);
        }
    });
  });
}, 1000);
</script>

<style>
  .lpe-container {
    display: flex;
  }
</style>

<div class="lpe-container">
  <textarea  id="input">Put your code here...</textarea>
  <div id="blocklyDiv"></div>
</div>

<button id="button" style="display:block">Transform</button>
